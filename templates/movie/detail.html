{% extends "base.html" %}

{% block title %}电影详情{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/movie_detail.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/comment.css') }}">
<script src="path/to/your/js/comments.js" defer></script>
<style>
    .star-rating {
        direction: rtl;
        display: inline-block;
        padding: 20px;
    }

    .star-rating input[type="radio"] {
        display: none;
    }

    .star-rating label {
        color: #bbb;
        font-size: 30px;
        padding: 0 10px;
        cursor: pointer;
    }

    .star-rating input[type="radio"]:checked~label {
        color: #f2b600;
    }

    .star-rating label:hover,
    .star-rating label:hover~label {
        color: #f2b600;
    }
</style>

<!-- 评论回复的css -->
<style>
    /* 样式化评论回复 */
    .reply-content {
        margin-top: 10px;
        /* 上边距 */
        padding: 10px;
        /* 内边距 */
        border: 1px solid #ccc;
        /* 边框 */
        background-color: #f9f9f9;
        /* 背景色 */
    }

    /* 头部表格样式 */
    .reply_header {
        width: 100%;
        border-collapse: collapse;
    }

    .reply_header .reply_avatar {
        width: 50px;
        /* 头像列宽度 */
        vertical-align: top;
    }

    .reply_header .reply_avatar img {
        width: 40px;
        /* 头像大小 */
        height: 40px;
        border-radius: 50%;
        /* 圆角 */
    }

    .reply_header .reply_username {
        vertical-align: top;
        padding-left: 10px;
        /* 用户名列内边距 */
    }

    /* 回复内容样式 */
    .reply_text {
        margin-top: 10px;
        /* 上边距 */
        font-size: 14px;
        /* 字体大小 */
        line-height: 1.5;
        /* 行高 */
    }

    /* 底部信息样式 */
    .reply_footer {
        margin-top: 10px;
        /* 上边距 */
        display: flex;
        /* 使用弹性盒子布局 */
        justify-content: space-between;
        /* 两端对齐 */
        align-items: center;
        /* 垂直居中对齐 */
        font-size: 12px;
        /* 字体大小 */
        color: #888;
        /* 字体颜色 */
    }

    .reply_footer .reply_date {
        flex: 1;
        /* 弹性增长 */
    }

    .reply_footer .reply_likes {
        flex: 1;
        /* 弹性增长 */
        text-align: center;
        /* 文本居中对齐 */
    }

    .reply_footer .reply_button {
        flex: 1;
        /* 弹性增长 */
        text-align: right;
        /* 文本右对齐 */
    }

    /* 点赞按钮样式 */
    .like-button {
        padding: 5px 10px;
        /* 按钮内边距 */
        border: none;
        /* 去掉边框 */
        background-color: #3498db;
        /* 背景色 */
        color: #fff;
        /* 字体颜色 */
        cursor: pointer;
        /* 光标指示 */
        border-radius: 3px;
        /* 圆角 */
    }

    .like-button:hover {
        background-color: #2980b9;
        /* 鼠标悬停时背景色 */
    }

    /* 回复按钮样式 */
    .reply-button {
        padding: 5px 10px;
        /* 按钮内边距 */
        border: none;
        /* 去掉边框 */
        background-color: #2ecc71;
        /* 背景色 */
        color: #fff;
        /* 字体颜色 */
        cursor: pointer;
        /* 光标指示 */
        border-radius: 3px;
        /* 圆角 */
    }

    .reply-button:hover {
        background-color: #27ae60;
        /* 鼠标悬停时背景色 */
    }
</style>



<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        // 使用事件委托来绑定点击事件
        document.body.addEventListener('click', function (event) {
            // 检查点击的目标是否是 .reply_button 内的 button 元素
            if (event.target && event.target.matches('.reply_button button')) {
                // 找到最近的 .single_comment 元素并获取其中的 .reply-form 表单
                var replyForm = event.target.closest('.single_comment').querySelector('.reply-form');
                // 切换 reply-form 表单的显示状态
                if (replyForm.style.display === 'none' || replyForm.style.display === '') {
                    replyForm.style.display = 'block'; // 显示表单
                } else {
                    replyForm.style.display = 'none'; // 隐藏表单
                }
            }
        });

        document.body.addEventListener('submit', function (event) {
            // 检查提交的目标是否是 .reply-form 表单
            if (event.target && event.target.matches('.reply-form')) {
                event.preventDefault(); // 阻止表单默认提交

                // 获取提交的回复表单
                var replyForm = event.target;

                // 获取回复内容
                var replyContent = event.target.querySelector('#content_text').value;

                // 如果回复内容为空，则直接返回，不执行后续操作
                if (replyContent.trim() === '') {
                    // 将表单设置成隐藏
                    replyForm.style.display = 'none';
                    alert("评论内容不能为空！");
                    return;
                }

                // 找到最近的 .single_comment 元素并获取其中的 .reply 容器
                var replyDiv = event.target.closest('.single_comment').querySelector('.reply');
                // 创建一个新的 div 来显示回复内容
                var newReply = document.createElement('div');
                newReply.className = 'reply-content';
                // 自定义新回复 div 的 HTML 结构
                newReply.innerHTML = `
                    <table class="reply_header">
                        <tbody>
                            <tr>
                                <td class="reply_avatar">
                                    <a href="{{ url_for('user.profile', username = g.current_user.username) }}">
                                        {% if g.current_user.avatar %}
                                        <img src="{{ url_for('static', filename=g.current_user.avatar) }}" alt="{{ g.current_user.username }}" class="user-avatar">
                                        {% else %}
                                        <img src="{{ url_for('static', filename='images/avatars/fixed_pics/default.jpg') }}" alt="{{ g.current_user.username }}" class="user-avatar">
                                    {% endif %}
                                    </a>
                                </td>
                                <td class="reply_username">
                                    <a href="{{ url_for('user.profile', username = g.current_user.username) }}">
                                        {{ g.current_user.username }}
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="reply_text">
                        ${replyContent}
                    </div>
                    <div class="reply_footer">
                        <div class="reply_date">
                            <span> 刚刚 </span>
                        </div>
                        <div class="reply_likes">
                            <button class="like-button">点赞</button>
                            <span class="like-count"> 0 </span>
                        </div>
                        <div class="reply_button">
                            <button class="reply-button">回复</button>
                        </div>
                    </div>
                `;
                // 将新回复添加到 .reply 容器中
                replyDiv.appendChild(newReply);

                // 清空文本框内容
                event.target.querySelector('#content_text').value = '';

                // 将表单设置成隐藏
                replyForm.style.display = 'none';

                // 模拟发送数据到后端
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/submit_reply', true); // 设置请求方法和URL
                xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8'); // 设置请求头
                xhr.send(JSON.stringify({
                    comment_id: event.target.querySelector('#towhom').value, // 获取要回复的评论 ID
                    content: replyContent, // 回复的内容
                }));

                // 处理请求响应
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        console.log('回复已发送'); // 成功响应日志
                    } else {
                        console.log('发送失败'); // 失败响应日志
                    }
                };
            }
        });
    });
</script>
{% endblock %}

{% block main %}
<div class="container">
    <div class="title">
        <span class="movie_name">{{ movie.title }}</span>
        <span class="movie_year">({{ movie.year }})</span>
    </div>
    <div class="movie_details">
        <table class="main_movie">
            <tbody>
                <tr>
                    <td class="pic">
                        <img src="{{ movie.poster }}" alt="电影海报" class="movie_poster">
                    </td>
                    <td class="more_details">
                        <div class="director">
                            <span class="explain">导演</span>:
                            {% for one_director in movie.director %}
                            <a href="{{ url_for('cast.cast_profile', id = one_director.id) }}">{{ one_director.name
                                }}</a>
                            {% if not loop.last %} / {% endif %}
                            {% endfor %}
                        </div>
                        <div class="casts">
                            <span class="explain">演员</span>:
                            {% for one_actor in movie.casts[:5] %}
                            <a href="{{ url_for('cast.cast_profile', id = one_actor.id) }}">{{ one_actor.name }}</a>
                            {% if not loop.last %} / {% endif %}
                            {% endfor %}
                        </div>
                        <div class="genres">
                            <span class="explain">类型</span>:
                            {{ movie.genres }}
                        </div>
                        <div class="duration">
                            <span class="explain">时长</span>:
                            {{ movie.duration }}分钟
                        </div>
                        <div class="imdb_rating">
                            <span class="explain">IMDb评分</span>:
                            {{ movie.imdb_rating }}
                        </div>
                        <div class="imdbID">
                            <span class="explain">IMDb ID</span>:
                            {{ movie.imdbID }}
                        </div>
                        {% if g.current_user %}
                        <div class="user_rating">
                            <span class="explain">请你进行评分</span>:
                            <form action="{{ url_for('movie.rating', id=movie.id) }}" method="post">
                                <div class="star-rating" oninput="updateScore()">
                                    <input type="radio" id="5-stars" name="rating" value="5" />
                                    <label for="5-stars" class="star">&#9733;</label>
                                    <input type="radio" id="4-stars" name="rating" value="4" />
                                    <label for="4-stars" class="star">&#9733;</label>
                                    <input type="radio" id="3-stars" name="rating" value="3" />
                                    <label for="3-stars" class="star">&#9733;</label>
                                    <input type="radio" id="2-stars" name="rating" value="2" />
                                    <label for="2-stars" class="star">&#9733;</label>
                                    <input type="radio" id="1-star" name="rating" value="1" />
                                    <label for="1-star" class="star">&#9733;</label>
                                </div>
                                <span id="score">0/10</span>
                                <br><br>
                                <button type="submit">提交评分</button>
                            </form>
                        </div>
                        {% endif %}
                    </td>
                    <td class="rating">
                        <div class="rating">
                            <span class="rating_num">
                                <span class="text">评分:</span>
                                <span class="num">{{ movie.local_rating }} / 10</span>
                            </span>
                            <div class="stars">
                                {% set rating_int = movie.local_rating | int %}
                                {% set full_stars = rating_int // 2 %}
                                {% set empty_stars = 5 - full_stars %}

                                {# 显示完整星星 #}
                                {% for _ in range(full_stars) %}
                                ★
                                {% endfor %}

                                {# 显示空星 #}
                                {% for _ in range(empty_stars) %}
                                ☆
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="plot">
        <h3 class="plot_title">剧情介绍</h3>
        <div class="plot_content">{{ movie.plot }}</div>
    </div>
    <div class="video-container">
        <h3>点击预告片链接播放视频</h3>
        <!-- YouTube 嵌入式播放器 -->
        <iframe width="560" height="315" src="{{ movie.trailer }}" frameborder="0" allowfullscreen></iframe>
    </div>
    <div class="relative_pics">
        <h3>电影相关图片</h3>
        <div class="person-container">
            {% for one_director in movie.director %}
            {% for worker in workers %}
            {% if worker.name == one_director.name %}
            <div class="person">
                <a href="{{ url_for('cast.cast_profile', id = one_director.id) }}">
                    <img src="{{ worker.avatar }}" alt="{{ one_director }}图片" class="person_avatar">
                </a>
                <div>导演：<a href="{{ url_for('cast.cast_profile', id = one_director.id) }}">{{ one_director.name }}</a>
                </div>
                <div>IMDb ID: <a href="https://www.imdb.com/name/{{ one_director.imdbID }}/">{{ one_director.imdbID
                        }}</a></div>
            </div>
            {% endif %}
            {% endfor %}
            {% endfor %}
            {% for one_actor in movie.casts[:5] %}
            {% for worker in workers %}
            {% if worker.name == one_actor.name %}
            <div class="person">
                <a href="{{ url_for('cast.cast_profile', id = one_actor.id) }}">
                    <img src="{{ worker.avatar }}" alt="{{ one_actor }}图片" class="person_avatar">
                </a>
                <div>演员：<a href="{{ url_for('cast.cast_profile', id = one_actor.id) }}">{{ one_actor.name }} ({% for
                        role in worker.role %} {{ role }} {% endfor %})</a></div>
                <div>IMDb ID: <a href="https://www.imdb.com/name/{{ one_actor.imdbID }}/">{{ one_actor.imdbID }}</a>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </div>
    </div>
    <div class="relative_comments">
        <h2>评论</h2>
        {% if g.current_user %}
        <div class="comments_to_write">
            <div class="user_info">
                <!-- 头像等信息 -->
            </div>
            <div class="comment_content">
                <textarea name="comment_text"></textarea>
                <textarea name="comment_text"></textarea>
                <button type="submit">提交</button>
            </div>
        </div>
        {% else %}
        <div class="comments_to_write">
            <span class="prompt">
                请先<a href="{{ url_for('user.login') }}">登录</a>再评论
            </span>
        </div>
        {% endif %}

        <div id="comments-section" class="comments_list">
            <div class="comments_history" id="comments_history">

                {% for review in reviews %}
                <div class="single_comment" id="{{ review.id }}">
                    <table class="writer_info">
                        <tbody>
                            <tr>
                                <td class="writer_profile">
                                    <a href="#">
                                        <img src="{{ review.writer_info.avatar }}" alt="评论者图片" width="100px">
                                    </a>
                                    {% else %}
                                    <a href="#">
                                        <img src="{{ url_for('static', filename='images/avatars/fixed_pics/default.jpg') }}"
                                            alt="评论者图片" width="100px">
                                    </a>
                                </td>
                                <td class="writer_name">
                                    <a href="{{ url_for('user.profile', username=review.writer_info.username) }}">{{ review.writer_info.username }}</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="review_content">
                        {{ review.content }}
                    </div>
                    <div class="comment_footer">
                        <div class="comment_date">
                            <span>{{ review.date }}</span>
                        </div>
                        <div class="comment_likes">
                            <button id="like-button">点赞</button>
                            <span id="like-count">{{ review.likes }}</span>
                        </div>
                        {% if g.current_user %}
                        <div class="reply_button">
                            <button id="reply_button">回复</button>
                        </div>
                        {% else %}
                        <div class="reply_button">
                            <a href="{{ url_for('user.login') }}">回复</a>
                        </div>
                        {% endif %}
                        {% if g.current_user.admin %}
                        <div class="delete">
                            <form action="{{ url_for('movie.delete_comment') }}" method="POST">
                                <input type="hidden" name="movie_id" value="{{ movie.id }}">
                                <input type="hidden" name="comment_id" id="comment_id" value="{{ review.id }}">
                                <input type="hidden" name="comment_date" id="comment_date" value="{{ review.date }}">
                                <input type="submit" name="delete" id="delete" style="color: red;" value="删除">
                            </form>
                        </div>
                        {% endif %}
                    </div>
                    <div class="reply">
                        <!-- 这里是该条评论的所有回复 -->
                    </div>
                    <form action="#" class="reply-form">
                        <textarea name="content_text" id="content_text"></textarea>
                        <input type="hidden" name="towhom" id="towhom" value="测试数据">
                        <input type="hidden" name="to_comment_id" id="to_comment_id" value="{{ review.id }}">
                        <button type="submit">发布</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const submitButton = document.querySelector('.comments_to_write button[type="submit"]');
        const commentTextArea = document.querySelector('.comments_to_write textarea');
        const newCommentContainer = document.getElementById('comments_history');
        const movieId = '{{ movie.id }}';  // 从模板变量获取电影ID

        submitButton.addEventListener('click', function (event) {
            event.preventDefault();

            const commentText = commentTextArea.value.trim();
            const commentDate = new Date().toISOString();  // 获取当前日期时间并格式化为ISO字符串

            if (commentText !== '') {
                const newCommentHTML = `
                <div class="single_comment">
                    <table class="writer_info">
                        <tbody>
                            <tr>
                                <td class="writer_profile">
                                    {% if g.current_user.avatar %}
                                    <a href="#">
                                        {% if g.current_user.avatar %}
                                        <img src="{{ url_for('static', filename=g.current_user.avatar)}}" alt="头像" width="100px">
                                        {% else %}
                                        <img src="{{ url_for('static', filename='images/avatars/fixed_pics/default.jpg')}}" alt="评论者图片" width="100px">
                                        {% endif %}
                                    </a>
                                    {% else %}
                                    <a href="#">
                                        <img src="{{ url_for('static', filename='images/avatars/fixed_pics/default.jpg') }}" alt="评论者图片" width="100px">
                                    </a>
                                    {% endif %}
                                </td>
                                <td class="writer_name">
                                    <a href="{{ url_for('user.profile', username=g.current_user.username) }}">{{ g.current_user.username }}</a>
                                    <span style="color: grey;">我</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="review_content">
                        ${commentText}
                    </div>
                    <div class="comment_footer">
                        <div class="comment_date">
                            <span> 刚刚 </span>
                        </div>
                        <div class="comment_likes">
                            <button class="like-button">点赞</button>
                            <span class="like-count"> 0 </span>
                        </div>
                        <div class="reply_button">
                            <button class="reply-button">回复</button>
                        </div>
                        {% if g.current_user.admin %}
                        <div class="delete">
                            <form action="{{ url_for('movie.delete_comment') }}" method="POST">
                                <input type="hidden" name="movie_id" value="{{ movie.id }}">
                                <input type="hidden" name="comment_date" id="comment_date" value='just_now'>
                                <input type="submit" name="delete" id="delete" style="color: red;" value="删除">
                            </form>
                        </div>
                        {% endif %}
                    </div>
                    <div class="reply">
                        <!-- 这里是该条评论的所有回复 -->
                    </div>
                    <form action="#" class="reply-form">
                        <textarea name="content_text" id="content_text"></textarea>
                        <input type="hidden" name="towhom" id="towhom" value="测试数据">
                        <button type="submit">发布</button>
                    </form>
                </div>
            `;

                newCommentContainer.insertAdjacentHTML('afterbegin', newCommentHTML);

                commentTextArea.value = '';

                fetch('{{ url_for("movie.add_comment") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ comment: commentText, movie_id: movieId, comment_date: commentDate })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('评论已提交到数据库:', data);
                    })
                    .catch(error => {
                        console.error('提交评论时出错:', error);
                        alert('提交评论时出错，请稍后再试。');
                    });
            }
        });
    });
</script>
</body>

</html>

{% endblock %}