{% extends "base.html" %}

{% block title %}电影详情{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/movie_detail.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/comment.css') }}">
{% endblock %}

{% block main %}
<div class="container">
    <p class="title">
        <span class="movie_name"> {{ movie.title }} </span>
        <span class="movie_year"> ({{ movie.year }})</span>
    </p>
    <div class="movie_details">
        <table class="main_movie">
            <tbody>
                <tr>
                    <td class="pic">
                        <img src="{{ movie.poster }}" alt="电影海报" width="250">
                    </td>
                    <td class="more_details">
                        <div class="director">
                            <span class="explain">导演</span>:
                            {% for one_director in movie.director %}
                            <a href="{{ url_for('cast.cast_profile', id = one_director.id) }}">{{ one_director.name
                                }}</a>
                            {% if not loop.last %} / {% endif %}
                            {% endfor %}
                        </div>
                        <div class="casts">
                            <span class="explain">演员</span>:
                            {% for one_actor in movie.casts[:5] %}
                            <a href="{{ url_for('cast.cast_profile', id = one_actor.id) }}">{{ one_actor.name }}</a>
                            {% if not loop.last %} / {% endif %}
                            {% endfor %}
                        </div>
                        <div class="genres">
                            <span class="explain">类型</span>:
                            {{ movie.genres }}
                        </div>
                        <div class="duration">
                            <span class="explain">时长</span>:
                            {{ movie.duration }}分钟
                        </div>
                        <div class="imdb_rating">
                            <span class="explain">IMDb评分</span>:
                            {{ movie.imdb_rating }}
                        </div>
                        <div class="imdbID">
                            <span class="explain">IMDb ID</span>:
                            {{ movie.imdbID }}
                        </div>
                    </td>
                    <td class="rating">
                        <div class="rating">
                            <span class="rating_num">
                                <span class="text">评分:</span>
                                <span class="num">{{ movie.local_rating }} / 10</span>
                            </span>
                            <div class="stars">
                                {% set rating_int = movie.local_rating | int %}
                                {% set full_stars = rating_int // 2 %}
                                {% set empty_stars = 5 - full_stars %}

                                {# 显示完整星星 #}
                                {% for _ in range(full_stars) %}
                                ★
                                {% endfor %}

                                {# 显示空星 #}
                                {% for _ in range(empty_stars) %}
                                ☆
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="plot">
        <h3 class="plot_title">剧情介绍</h3>
        <div class="plot_content">{{ movie.plot }}</div>
    </div>
    <div class="video-container">
        <h3>点击预告片链接播放视频</h2>
            <!-- YouTube 嵌入式播放器 -->
            <iframe width="560" height="315" src="{{ movie.trailer }}" frameborder="0" allowfullscreen></iframe>
    </div>
    <div class="relative_pics">电影相关图片</div>
    <div class="container">
        {% for one_director in movie.director %}
        {% for worker in workers %}
        {% if worker.name == one_director.name %}
        <div class="person">
            <div>
                <a href="{{ url_for('cast.cast_profile', id = one_director.id) }}"><img src="{{ worker.avatar }}"
                        alt="{{ one_director }}图片" width="150px"></a>
            </div>
            <div>导演：<a href="{{ url_for('cast.cast_profile', id = one_director.id) }}">{{ one_director.name }}</a></div>
            <div>IMDb ID: <a href="https://www.imdb.com/name/{{ one_director.imdbID }}/">{{ one_director.imdbID }}</a>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        {% endfor %}
        {% for one_actor in movie.casts[:3] %}
        {% for worker in workers %}
        {% if worker.name == one_actor.name %}
        <div class="person">
            <div>
                <a href="{{ url_for('cast.cast_profile', id = one_actor.id) }}"><img src="{{ worker.avatar }}"
                        alt="{{ one_actor }}图片" width="150px"></a>
            </div>
            <div>演员：<a href="{{ url_for('cast.cast_profile', id = one_actor.id) }}">{{ one_actor.name }} ({% for role in
                    worker.role %} {{ role }} {% endfor %})</a></div>
            <div>IMDb ID: <a href="https://www.imdb.com/name/{{ one_actor.imdbID }}/">{{ one_actor.imdbID }}</a></div>
        </div>
        {% endif %}
        {% endfor %}
        {% endfor %}
    </div>
    <div class="relative_comments">
        <h2>评论</h2>
        <div class="comments_to_write">
            <div class="user_info">
                <!-- 头像等信息 -->
            </div>
            <div class="comment_content">
                <textarea name="comment_text">
                </textarea>
                <button type="submit">提交</button>
            </div>
        </div>
        <div id="comments-section" class="comments_list">
            <div class="comments_history" id="comments_history">
                {% for review in reviews %}
                <div class="single_comment">
                    <table class="writer_info">
                        <tbody>
                            <tr>
                                <td class="writer_profile">
                                    <a href="#">
                                        <img src="{{review.writer_info.avatar }}" alt="评论者图片" width="100px">
                                    </a>
                                </td>
                                <td class="writer_name">
                                    <a href="#">{{ review.writer_info.username }}</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="review_content">
                        {{ review.content }}
                    </div>
                    <div class="comment_footer">
                        <div class="comment_date">
                            <span>{{ review.date }}</span>
                        </div>
                        <div class="comment_likes">
                            <button id="like-button">点赞</button>
                            <span id="like-count">{{ review.likes }}</span>
                        </div>
                        <div class="reply_button">
                            <button id="reply_button">回复</button>
                        </div>
                    </div>
                    <div class="reply">
                        <!-- 这里是该条评论的所有回复 -->
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const submitButton = document.querySelector('.comments_to_write button[type="submit"]');
        const commentTextArea = document.querySelector('.comments_to_write textarea');
        const newCommentContainer = document.getElementById('comments_history');
        const currentUser = {{ 'true' if g.current_user else 'false' }};  // 使用模板语言传递用户登录状态

        submitButton.addEventListener('click', function (event) {
            event.preventDefault(); // 阻止表单提交默认行为

            // 判断用户是否已登录
            if (!currentUser) {
                alert('您尚未登录，请先登录。');
                window.location.href = "{{ url_for('user.login') }}"; // 跳转到登录界面
                return; // 终止函数执行
            }

            const commentText = commentTextArea.value.trim(); // 获取评论内容并去除首尾空白

            if (commentText !== '') {
                // 创建新评论的HTML结构
                const newCommentHTML = `
                    <div class="single_comment">
                        <table class="writer_info">
                            <tbody>
                                <tr>
                                    <td class="writer_profile">
                                        <a href="#">
                                            <img src="{{ url_for('static', filename=g.current_user.avatar) }}" alt="评论者图片" width="100px">
                                        </a>
                                    </td>
                                    <td class="writer_name">
                                        <a href="#">{{ g.current_user.username }}</a>
                                        <span style="color: grey;">我</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="review_content">
                            ${commentText} 
                        </div>
                        <div class="comment_footer">
                            <div class="comment_date">
                                <span> 刚刚 </span>
                            </div>
                            <div class="comment_likes">
                                <button class="like-button">点赞</button>
                                <span class="like-count"> 0 </span>
                            </div>
                            <div class="reply_button">
                                <button class="reply-button">回复</button>
                            </div>
                        </div>
                        <div class="reply">
                            <!-- 这里是该条评论的所有回复 -->
                        </div>
                    </div>
                `;

                // 将新评论内容插入到评论容器的顶部
                newCommentContainer.insertAdjacentHTML('afterbegin', newCommentHTML);

                // 清空评论框
                commentTextArea.value = '';

                // TODO: 这里需要添加将评论提交给后端数据库的代码
                // 通过Ajax请求将评论内容发送给后端

                // 示例：使用fetch发送POST请求
                fetch('/submit_comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ comment: commentText })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('评论已提交到数据库:', data);
                        // 这里可以根据需要处理服务器响应
                    })
                    .catch(error => {
                        console.error('提交评论时出错:', error);
                        alert('提交评论时出错，请稍后再试。');
                    });
            }
        });

        // 使用事件委托绑定点赞和回复按钮事件
        newCommentContainer.addEventListener('click', function (event) {
            if (event.target.classList.contains('like-button')) {
                // 处理点赞功能
                const likeCountSpan = event.target.nextElementSibling;
                let likeCount = parseInt(likeCountSpan.textContent);
                likeCountSpan.textContent = likeCount + 1;
            } else if (event.target.classList.contains('reply-button')) {
                // 处理回复功能
                const replyContainer = event.target.closest('.single_comment').querySelector('.reply');
                const replyTextArea = document.createElement('textarea');
                const replySubmitButton = document.createElement('button');
                replySubmitButton.textContent = '提交回复';
                
                replyContainer.appendChild(replyTextArea);
                replyContainer.appendChild(replySubmitButton);

                replySubmitButton.addEventListener('click', function () {
                    const replyText = replyTextArea.value.trim();
                    if (replyText !== '') {
                        // 这里可以添加处理回复提交的代码
                        const newReplyHTML = `<div class="single_reply">${replyText}</div>`;
                        replyContainer.insertAdjacentHTML('beforeend', newReplyHTML);
                        replyTextArea.remove();
                        replySubmitButton.remove();
                    }
                });
            }
        });
    });
</script>
{% endblock %}